{% extends 'layouts/base-admin.html' %}

{% block title %} Tables {% endblock title %}

{% block content %}

<div class="header bg-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-4">
                <div class="col-lg-6 col-7">
                    <h6 class="h2 text-white d-inline-block mb-0">Tables</h6>
                    <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                        <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                            <li class="breadcrumb-item"><a href="{{url_for('admin.admin')}}"><i class="fas fa-home"></i></a>
                            </li>
                            <li class="breadcrumb-item"><a href="{{url_for('stock_management.stock_management')}}">Kho
                                Hàng</a></li>
                            <li class="breadcrumb-item"><a
                                    href="{{url_for('stock_management.stock_product', id_stock=id_stock)}}">Quản Lý Sản
                                Phẩm</a></li>
                            <li class="breadcrumb-item active">{{id_stock}}</li>
                        </ol>
                    </nav>
                </div>
                <div class="col-lg-6 col-5 text-right">
                    <a
                            class="btn btn-sm btn-neutral" data-target="#modal-form"
                            data-toggle="modal">Thêm Sản Phẩm Vào Kho</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Page content -->
<div class="container-fluid mt--6">

    <div class="row">
        <div class="col">
            <div class="card">
                <!-- Card header -->
                <div class="card-header border-0">
                    <h3 class="mb-0">{{title}}</h3>
                </div>
                <!-- Light table -->
                <div class="table-responsive">
                    <table class="table align-items-center table-flush">
                        <thead class="thead-light">
                        <tr>
                            <th class="sort" data-sort="name" scope="col">Tên Sản Phẩm</th>
                            <th class="sort" data-sort="quantity" scope="col">Số Lượng</th>
                            <th class="sort" data-sort="price" scope="col">Giá</th>
                            <th scope="col"></th>
                        </tr>
                        </thead>
                        <tbody class="list">
                        {% for product in stock_product %}
                        <tr>
                            <th scope="row">
                                <div class="media align-items-center">
                                    <div class="avatar-group">
                                        {% for item in product.image_url %}
                                        <a class="avatar avatar-sm rounded-circle" href="#">
                                            <img alt="Image placeholder" src={{item}}>
                                        </a>
                                        {% endfor %}
                                    </div>
                                    <div class="media-body">
                                        <span class="name mb-0 text-sm">{{product.name}}</span>
                                    </div>
                                </div>
                            </th>
                            <td class="budget">
                                {{product.quantity}}
                            </td>
                            <td class="budget">
                                {{product.price}}
                            </td>
                            <td class="text-center">
                                <div class="dropdown">
                                    <a aria-expanded="false" aria-haspopup="true"
                                       class="btn btn-sm btn-icon-only text-light"
                                       data-toggle="dropdown" href="#" role="button">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right dropdown-menu-arrow">
                                        <a id="{{product.product_id}}"
                                           data-name="{{product.name}}"
                                           data-quantity="{{product.quantity}}"
                                           onclick="editStockProduct(this)"
                                           class="dropdown-item" data-toggle="modal"
                                           data-target="#modal-edit">Sửa</a>
                                        <a class="dropdown-item" id="{{product.id}}"
                                           onclick="deleteProduct(this)">Xóa</a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
    <div class="col-8">
        <div aria-hidden="true" aria-labelledby="modal-form" class="modal fade" id="modal-form" role="dialog"
             tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-md" role="document">
                <div class="modal-content ">
                    <div class="modal-body p-0">
                        <div class="card bg-secondary shadow border-0">
                            <div class="card-header bg-transparent pb-5">
                                <div class="text-muted text-center mt-2 mb-3"><small>Thêm Sản Phẩm vào Kho </small>
                                </div>
                            </div>
                            <div class="card-body px-lg-5 py-lg-5">
                                <form enctype="multipart/form-data" method="post" onsubmit="return submitFormData()">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="input-product">Sản Phẩm</label>
                                                <select class="form-control" id="input-product">
                                                    {% for product in products %}
                                                    <option value="{{product.id}}">
                                                        {{product.name}}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="form-group">
                                                <label class="form-control-label" for="input-quantity">Số
                                                    Lượng</label>
                                                <input class="form-control" id="input-quantity" placeholder="Số Lượng"
                                                       type="text" required
                                                >
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-center">
                                        <a class="btn btn-sm "
                                           class="close" data-dismiss="modal"
                                        >Hủy Bỏ</a>
                                        <button class="btn btn-sm btn-primary" type="submit">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-8">
        <div aria-hidden="true" aria-labelledby="modal-edit" class="modal fade" id="modal-edit" role="dialog"
             tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-md" role="document">
                <div class="modal-content ">
                    <div class="modal-body p-0">
                        <div class="card bg-secondary shadow border-0">
                            <div class="card-header bg-transparent pb-5">
                                <div class="text-muted text-center mt-2 mb-3"><small>Sửa Sản Phẩm</small>
                                </div>
                            </div>
                            <div class="card-body px-lg-5 py-lg-5">
                                <form enctype="multipart/form-data" method="post"
                                      onsubmit="return submitFormEditData()">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="input-product">Sản Phẩm</label>
                                                <div id="product_name"></div>

                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="form-group">
                                                <label class="form-control-label" for="input-quantity">Số
                                                    Lượng</label>
                                                <input class="form-control" id="product_quantity" placeholder="Số Lượng"
                                                       type="text" required
                                                >
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-center">
                                        <a class="btn btn-sm "
                                           class="close" data-dismiss="modal"
                                        >Hủy Bỏ</a>
                                        <button class="btn btn-sm btn-primary" type="submit">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        let product = null

        function submitFormData() {
            swal({
                title: "Are you sure?",
                text: "Kiểm Tra Thông Tin Trước khi gửi",
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        var formData = new FormData();
                        const product_id = document.getElementById("input-product").value;
                        const quantity = document.getElementById("input-quantity").value;
                        formData.append("product_id", product_id);
                        formData.append("quantity", quantity);
                        $.ajax({
                            type: "POST",
                            url: "{{url_for('stock_management.stock_product', id_stock = id_stock, mode='merge')}}",
                            data: formData,
                            contentType: false,
                            processData: false,
                            success: function (data) {
                                let objData = JSON.parse(data);
                                let idstock = parseInt(objData.id_stock);
                                if (idstock) {
                                    window.location.reload();
                                } else {
                                    swal(objData.message, {
                                        icon: "warning",
                                    });
                                }
                            },
                            error: function (e) {
                                swal(e.responseText);
                            }
                        });
                        return false;
                    } else {
                        return false;
                    }
                });
            return false;
        }

        function submitFormEditData() {
            swal({
                title: "Are you sure?",
                text: "Kiểm Tra Thông Tin Trước khi gửi",
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        var formData = new FormData();
                        const input_product_quantity = document.getElementById("product_quantity").value
                        if (product) {
                            formData.append("product_id", product.product_id);
                            formData.append("quantity", input_product_quantity);
                        }
                        $.ajax({
                            type: "POST",
                            url: "{{url_for('stock_management.stock_product', id_stock = id_stock, mode='change')}}",
                            data: formData,
                            contentType: false,
                            processData: false,
                            success: function (data) {
                                let objData = JSON.parse(data);
                                let idstock = parseInt(objData.id_stock);
                                if (idstock) {
                                    window.location.reload();
                                } else {
                                    swal(objData.message, {
                                        icon: "warning",
                                    });
                                }
                            },
                            error: function (e) {
                                document.innerHTML = e.responseText
                            }
                        });
                        return false;
                    } else {
                        return false;
                    }
                });
            return false;
        }

        function editStockProduct(att) {
            const product_name = att.getAttribute("data-name")
            const product_quantity = att.getAttribute("data-quantity")
            product = {
                product_id: att.id,
                quantity: product_quantity
            }
            const input_product_name = document.getElementById("product_name")
            const input_product_quantity = document.getElementById("product_quantity")
            input_product_name.innerHTML = `<span class="badge badge-default" id="product_name">${product_name}</span>`
            input_product_quantity.value = product_quantity
        }

        function deleteProduct(obj) {
            let idStockProduct = obj.id;
            swal({
                title: "Are you sure?",
                text: "Once deleted, you will not be able to restore this object!",
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        $.ajax({
                            type: "POST",
                            url: "/admin/stock_management/stock_product/delete/" + idStockProduct,
                            success: function (data) {
                                swal(data, {
                                    icon: "success",
                                }).then(() => {
                                    location.reload()
                                });
                            },
                            error: function (e) {
                                swal(e.responseText);
                            }
                        });
                    } else {
                    }
                });
        }

    </script>
</div>
{% endblock content %}


